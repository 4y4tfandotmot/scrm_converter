<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>[ scrm converter ]</title>
<style>
body {
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(180deg, #2d2d2d, #363a5c);
    font-family: Arial, sans-serif;
    color: white;
}

.container {
    text-align: center;
}

h1 {
    font-size: 24px;
    margin-bottom: 25px;
}

button {
    background: #1b1b1b;
    color: #ffffff;
    border: 1px solid rgba(93, 126, 216, 0.678);
    padding: 9px 22px;
    font-size: 13px;
    cursor: pointer;
    margin-top: 18px;
    border-radius: 10px;
    letter-spacing: 0.5px;
    transition: 
        background 0.2s ease,
        box-shadow 0.2s ease,
        transform 0.12s ease;
}
button:hover {
    background: #242424;
    box-shadow: 0 0 6px rgba(255,255,255,0.15);
    transform: translateY(-1px);
}
button:active {
    transform: scale(0.97);
    background: #131313;
}

input[type=number] {
    width: 80px;
    padding: 6px;
    border-radius: 5px;
    border: none;
    background: #1f1f1f;
    color: white;
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
}

input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type=number] {
    -moz-appearance: textfield;
}

#status {
    margin-top: 20px;
    font-size: 14px;
    opacity: 0.8;
}
</style>
</head>
<body>

<div class="container">
<h1>[ scrm converter ]</h1>

<div>[ resolution ]</div>
<input type="number" id="res" value="300" min="1" max="300">

<br>

<button onclick="openFile()">bild auswählen (png)</button>
<input type="file" id="file" accept="image/png" style="display:none" onchange="convertImage()">

<canvas id="canvas" style="display:none"></canvas>

<div id="status"></div>
</div>

<script>

// ---- Parameter aus Python ----
const BLUR_RADIUS = 0;
const SAT_EXPONENT = 1.6;
const SAT_SCALE = 0.60;
const VAL_EXPONENT = 1.15;
const VAL_SCALE = 0.95;
const CONTRAST = 0.92;

function clamp01(x) {
    return x < 0 ? 0 : x > 1 ? 1 : x;
}

function rgbToHsv(r, g, b) {
    r /= 255; g /= 255; b /= 255;
    let max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, v = max;
    let d = max - min;
    s = max === 0 ? 0 : d / max;

    if (d === 0) h = 0;
    else if (max === r) h = ((g - b) / d) % 6;
    else if (max === g) h = (b - r) / d + 2;
    else h = (r - g) / d + 4;

    h = Math.round(h * 60);
    if (h < 0) h += 360;
    return [h/360, s, v];  // Normalisiert h (0-1), s, v
}

function processImageData(data, resolution) {
    let out = "";
    // Python läuft von unten nach oben -> JS Array umkehren
    for (let y = resolution - 1; y >= 0; y--) {
        for (let x = 0; x < resolution; x++) {
            let idx = (y * resolution + x) * 4;
            let r = data[idx], g = data[idx+1], b = data[idx+2];

            let [h, s, v] = rgbToHsv(r, g, b);
            s = clamp01(Math.pow(s, SAT_EXPONENT) * SAT_SCALE);
            v = clamp01(Math.pow(v, VAL_EXPONENT) * VAL_SCALE);
            v = 0.5 + (v - 0.5) * CONTRAST;
            v = clamp01(v);

            let hs = Math.round(h * 99);
            let ss = Math.round(s * 99);
            let vs = Math.round(v * 99);

            hs = Math.min(99, Math.max(0, hs));
            ss = Math.min(99, Math.max(0, ss));
            vs = Math.min(99, Math.max(0, vs));

            out += `${hs.toString().padStart(2,'0')}${ss.toString().padStart(2,'0')}${vs.toString().padStart(2,'0')}`;
        }
    }
    return out;
}

function openFile() {
    document.getElementById("file").click();
}

function convertImage() {
    let file = document.getElementById("file").files[0];
    if (!file) return;

    let img = new Image();
    img.onload = function() {
        let resolution = parseInt(document.getElementById("res").value);
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");

        canvas.width = resolution;
        canvas.height = resolution;

        ctx.drawImage(img, 0, 0, resolution, resolution);

        if (BLUR_RADIUS > 0) {
            // optional: einfacher Box Blur
            ctx.globalAlpha = 0.5;
            for (let y=-BLUR_RADIUS; y<=BLUR_RADIUS; y++){
                for (let x=-BLUR_RADIUS; x<=BLUR_RADIUS; x++){
                    ctx.drawImage(canvas, x, y, resolution, resolution);
                }
            }
            ctx.globalAlpha = 1.0;
        }

        let data = ctx.getImageData(0, 0, resolution, resolution).data;
        let result = processImageData(data, resolution);

        // Meta info anhängen (wie Python)
        let meta = resolution.toString();
        result += meta + meta.length.toString();

        navigator.clipboard.writeText(result).then(() => {
            document.getElementById("status").innerText = `✓ kopiert (${result.length} chars)`;
        });
    };

    let reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(file);
}

</script>
</body>
</html>
